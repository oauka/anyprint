
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>애니프린트 - 가이드선 + 스냅</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
  <style>
    body { margin: 0; background: #f5f5f5; font-family: sans-serif; }
    .toolbar {
      padding: 10px; background: #fff; display: flex; flex-wrap: wrap; gap: 10px;
      border-bottom: 1px solid #ccc; justify-content: center;
    }
    canvas { display: block; margin: 20px auto; border: 1px solid #333; }
  </style>
</head>
<body>
  <div class="toolbar">
    <label>배경:</label><input type="color" id="bgColor" value="#ffffff" />
    <label>글자색:</label><input type="color" id="fontColor" value="#000000" />
    <label>크기:</label>
    <select id="fontSizeSelect"></select>
    <button onclick="addGuideLine('horizontal')">가로선</button>
    <button onclick="addGuideLine('vertical')">세로선</button>
    <input type="file" id="logoUpload" />
    <button onclick="downloadImage()">저장</button>
  </div>

  <canvas id="canvas" width="1087" height="614"></canvas>

  <script>
    const canvas = new fabric.Canvas('canvas', { selection: true });
    const CANVAS_WIDTH = 1087;
    const CANVAS_HEIGHT = 614;

    // 재단선 기준
    const frameX = (CANVAS_WIDTH - 1063) / 2;
    const frameY = (CANVAS_HEIGHT - 591) / 2;
    const frameWidth = 1063;
    const frameHeight = 591;
    const centerX = frameX + frameWidth / 2;
    const centerY = frameY + frameHeight / 2;

    canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));

    // 재단선 및 세이프박스
    const trimBox = new fabric.Rect({
      left: frameX, top: frameY, width: frameWidth, height: frameHeight,
      stroke: "red", strokeWidth: 1, fill: "", selectable: false, evented: false
    });

    canvas.add(trimBox);

    // 기준선 추가 함수 (2, 3, 4등분 기준)
    function addFixedGuides() {
      const verticals = [centerX,
        frameX + frameWidth / 3,
        frameX + (frameWidth / 3) * 2,
        frameX + frameWidth / 4,
        frameX + (frameWidth / 4) * 3
      ];
      const horizontals = [centerY,
        frameY + frameHeight / 3,
        frameY + (frameHeight / 3) * 2,
        frameY + frameHeight / 4,
        frameY + (frameHeight / 4) * 3
      ];

      verticals.forEach(x => {
        const line = new fabric.Line([x, 0, x, CANVAS_HEIGHT], {
          stroke: 'rgba(0,0,0,0.08)', strokeWidth: 1,
          selectable: false, evented: false
        });
        canvas.add(line);
      });

      horizontals.forEach(y => {
        const line = new fabric.Line([0, y, CANVAS_WIDTH, y], {
          stroke: 'rgba(0,0,0,0.08)', strokeWidth: 1,
          selectable: false, evented: false
        });
        canvas.add(line);
      });
    }

    // 사용자 드래그로 추가하는 가이드선
    function addGuideLine(type) {
      const isHorizontal = type === 'horizontal';
      const pos = isHorizontal ? centerY : centerX;
      const line = new fabric.Line(
        isHorizontal ? [0, pos, CANVAS_WIDTH, pos] : [pos, 0, pos, CANVAS_HEIGHT],
        {
          stroke: "rgba(0,0,255,0.3)",
          strokeDashArray: [5, 5],
          strokeWidth: 1,
          selectable: true,
          hasControls: false,
          hoverCursor: "move",
        }
      );
      line.lockRotation = true;
      canvas.add(line);
    }

    // 기본 텍스트 추가
    const defaultTexts = [
      { text: "홍길동", top: centerY - 60 },
      { text: "대표", top: centerY },
      { text: "010-1234-5678", top: centerY + 60 }
    ];
    defaultTexts.forEach((item, i) => {
      const text = new fabric.IText(item.text, {
        left: centerX,
        top: item.top,
        fontSize: 10,
        fill: "#000",
        originX: "center",
        textAlign: "center",
        width: 500,
        splitByGrapheme: true
      });
      canvas.add(text);
    });

    // 스냅 기능: 객체 이동 중 가이드라인 근처에서 정렬
    canvas.on("object:moving", function (e) {
      const SNAP_TOLERANCE = 5;
      const obj = e.target;

      canvas.getObjects().forEach(o => {
        if (o === obj || o.type !== 'line' || !o.selectable) return;

        const isHorizontal = o.y1 === o.y2;
        const guidePos = isHorizontal ? o.y1 : o.x1;
        const objPos = isHorizontal ? obj.top : obj.left;

        if (Math.abs(guidePos - objPos) < SNAP_TOLERANCE) {
          if (isHorizontal) obj.top = guidePos;
          else obj.left = guidePos;
        }
      });
    });

    // 기타 설정들
    document.getElementById("bgColor").oninput = e => {
      canvas.setBackgroundColor(e.target.value, canvas.renderAll.bind(canvas));
    };

    document.getElementById("fontColor").oninput = e => {
      const obj = canvas.getActiveObject();
      if (obj && obj.type === "i-text") {
        obj.set("fill", e.target.value);
        canvas.renderAll();
      }
    };

    const fontSizeSelect = document.getElementById("fontSizeSelect");
    for (let i = 6; i <= 72; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i + " pt";
      if (i === 10) opt.selected = true;
      fontSizeSelect.appendChild(opt);
    }

    fontSizeSelect.onchange = e => {
      const obj = canvas.getActiveObject();
      if (obj && obj.type === "i-text") {
        obj.set("fontSize", parseInt(e.target.value));
        canvas.renderAll();
      }
    };

    document.getElementById("logoUpload").onchange = function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        fabric.Image.fromURL(event.target.result, function (img) {
          img.scaleToWidth(100);
          img.left = frameX + 20;
          img.top = frameY + 20;
          canvas.add(img);
        });
      };
      reader.readAsDataURL(e.target.files[0]);
    };

    function downloadImage() {
      const dataURL = canvas.toDataURL({ format: "png", quality: 1.0 });
      const a = document.createElement("a");
      a.href = dataURL;
      a.download = "anyprint_guidesnap.png";
      a.click();
    }

    addFixedGuides();
  </script>
</body>
</html>
